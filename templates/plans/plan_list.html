{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Telecom Plans - TelecomPedia{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold mb-3 text-gradient">Find Your Perfect Plan</h1>
            <p class="lead text-muted mb-4">
                Compare plans across all major operators. Filter by your needs and find the best deal.
            </p>
            
            <!-- Quick Filter Chips -->
            <div class="d-flex flex-wrap gap-2">
                <a href="?plan_type=popular&plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}" class="badge bg-warning text-dark p-2 text-decoration-none">
                    <i class="fas fa-fire me-1"></i> Trending
                </a>
                <a href="?plan_type=featured&plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}" class="badge bg-primary p-2 text-decoration-none">
                    <i class="fas fa-star me-1"></i> Featured
                </a>
                <a href="?price_range=0-100&plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}" class="badge bg-success p-2 text-decoration-none">
                    <i class="fas fa-rupee-sign me-1"></i> Budget Plans
                </a>
                <a href="?data=unlimited&plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}" class="badge bg-info p-2 text-decoration-none">
                    <i class="fas fa-infinity me-1"></i> Unlimited Data
                </a>
                <a href="?validity=28&plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}" class="badge bg-purple p-2 text-decoration-none">
                    <i class="fas fa-calendar me-1"></i> Monthly Plans
                </a>
            </div>
        </div>
        <div class="col-lg-4 text-lg-end">
            <a href="{% url 'compare_plans' %}" class="btn btn-primary btn-lg shadow-lg">
                <i class="fas fa-balance-scale me-2"></i> Compare Plans
            </a>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-lg rounded-4 sticky-top" style="top: 20px;">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4 d-flex align-items-center">
                        <i class="fas fa-filter me-2 text-primary"></i>
                        Filters
                    </h5>
                    
                    <form method="get" id="filterForm">
                        <!-- Plan Type Filter (Important) -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Connection Type</label>
                            <div class="vstack gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="plan_type_filter" value="new_connection" 
                                           id="filter-new-connection" 
                                           {% if request.GET.plan_type_filter == 'new_connection' or not request.GET.plan_type_filter %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label d-flex align-items-center" for="filter-new-connection">
                                        <span class="badge bg-success-subtle text-success me-2 p-1">
                                            <i class="fas fa-sim-card"></i>
                                        </span>
                                        <div>
                                            <span class="fw-medium">New Connection</span>
                                            <small class="text-muted d-block">Plans for new SIM cards</small>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="plan_type_filter" value="port_in" 
                                           id="filter-port-in" 
                                           {% if request.GET.plan_type_filter == 'port_in' %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label d-flex align-items-center" for="filter-port-in">
                                        <span class="badge bg-info-subtle text-info me-2 p-1">
                                            <i class="fas fa-exchange-alt"></i>
                                        </span>
                                        <div>
                                            <span class="fw-medium">Port-in (MNP)</span>
                                            <small class="text-muted d-block">Special plans for number porting</small>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="plan_type_filter" value="" 
                                           id="filter-all-plans" 
                                           {% if request.GET.plan_type_filter == '' and 'plan_type_filter' in request.GET %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label d-flex align-items-center" for="filter-all-plans">
                                        <span class="badge bg-secondary-subtle text-secondary me-2 p-1">
                                            <i class="fas fa-list"></i>
                                        </span>
                                        <div>
                                            <span class="fw-medium">All Plans</span>
                                            <small class="text-muted d-block">Show all plan types</small>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Operator Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Operator</label>
                            <div class="vstack gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="operator" value="" 
                                           id="all-operators" {% if not request.GET.operator %}checked{% endif %} 
                                           onchange="this.form.submit()">
                                    <label class="form-check-label" for="all-operators">
                                        <span class="badge bg-light text-dark">All Operators</span>
                                    </label>
                                </div>
                                {% for op in all_operators %}
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="operator" value="{{ op.id }}" 
                                           id="operator-{{ op.id }}" {% if request.GET.operator == op.id|stringformat:"i" %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label d-flex align-items-center" for="operator-{{ op.id }}">
                                        {% if op.logo %}
                                        <img src="{{ op.logo.url }}" alt="{{ op.name }}" 
                                             class="rounded-circle me-2" style="width: 24px; height: 24px; object-fit: contain;">
                                        {% endif %}
                                        <span>{{ op.name }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <!-- Category Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Category</label>
                            <select name="category" class="form-select border-primary" onchange="this.form.submit()">
                                <option value="">All Categories</option>
                                {% for cat in categories %}
                                <option value="{{ cat.id }}" {% if request.GET.category == cat.id|stringformat:"i" %}selected{% endif %}>
                                    {{ cat.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Price Range -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Price Range</label>
                            <input type="range" class="form-range" min="0" max="2000" step="50" 
                                   id="priceRange" onchange="updatePriceValue(this.value)">
                            <div class="d-flex justify-content-between">
                                <small>₹0</small>
                                <small id="priceValue">₹{% if request.GET.max_price %}{{ request.GET.max_price }}{% else %}2000{% endif %}</small>
                                <small>₹2000</small>
                            </div>
                            <input type="hidden" name="max_price" id="maxPrice" 
                                   value="{{ request.GET.max_price|default:2000 }}" onchange="this.form.submit()">
                        </div>
                        
                        <!-- Data Allowance -->
                        <div class="mb-4">
                            <label class="form-label fw-semibold mb-3">Daily Data</label>
                            <div class="vstack gap-2">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="data" value="unlimited" 
                                           id="unlimited-data" {% if "unlimited" in request.GET.data %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label" for="unlimited-data">
                                        <i class="fas fa-infinity me-1 text-success"></i> Unlimited
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="data" value="2gb+" 
                                           id="2gb-data" {% if "2gb+" in request.GET.data %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label" for="2gb-data">
                                        <i class="fas fa-database me-1 text-info"></i> 2GB+ Daily
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="data" value="1gb+" 
                                           id="1gb-data" {% if "1gb+" in request.GET.data %}checked{% endif %}
                                           onchange="this.form.submit()">
                                    <label class="form-check-label" for="1gb-data">
                                        <i class="fas fa-database me-1 text-warning"></i> 1GB+ Daily
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clear Filters -->
                        {% if request.GET %}
                        <div class="mt-4 pt-3 border-top">
                            <a href="{% url 'plan_list' %}" class="btn btn-outline-danger w-100">
                                <i class="fas fa-times me-1"></i> Clear Filters
                            </a>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Plans Grid -->
        <div class="col-lg-9">
            <!-- Results Header with Plan Type Toggle -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <!-- Plan Type Toggle Buttons -->
                    <div class="card border-0 shadow-sm rounded-4 mb-3">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center">
                                <label class="form-label fw-semibold mb-0 me-3">Show:</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="plan_type_toggle" id="toggle_new_connection" 
                                           value="new_connection" 
                                           {% if request.GET.plan_type_filter == 'new_connection' or not request.GET.plan_type_filter %}checked{% endif %}
                                           onchange="togglePlanType(this.value)">
                                    <label class="btn btn-outline-primary rounded-start-3" for="toggle_new_connection">
                                        <i class="fas fa-sim-card me-1"></i> New Connection
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="plan_type_toggle" id="toggle_port_in" 
                                           value="port_in"
                                           {% if request.GET.plan_type_filter == 'port_in' %}checked{% endif %}
                                           onchange="togglePlanType(this.value)">
                                    <label class="btn btn-outline-primary rounded-end-3" for="toggle_port_in">
                                        <i class="fas fa-exchange-alt me-1"></i> Port-in (MNP)
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!-- Results Count -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="fw-bold mb-1">
                                {% if plans %}
                                <span class="text-primary">{{ plans.paginator.count }}</span> 
                                {% if request.GET.plan_type_filter == 'new_connection' %}
                                    New Connection Plans
                                {% elif request.GET.plan_type_filter == 'port_in' %}
                                    Port-in (MNP) Plans
                                {% else %}
                                    Plans Available
                                {% endif %}
                                {% else %}
                                No Plans Found
                                {% endif %}
                            </h3>
                            {% if request.GET.plan_type_filter == 'port_in' %}
                            <p class="text-muted small mb-0">
                                <i class="fas fa-info-circle text-info me-1"></i>
                                Special plans for Mobile Number Portability (MNP)
                            </p>
                            {% endif %}
                        </div>
                        
                        <!-- Sort Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-sort me-1"></i>
                                {% if request.GET.sort == "-price" %}Price: High-Low
                                {% elif request.GET.sort == "price" %}Price: Low-High
                                {% elif request.GET.sort == "-validity" %}Validity: High-Low
                                {% elif request.GET.sort == "validity" %}Validity: Low-High
                                {% elif request.GET.sort == "popular" %}Most Popular
                                {% elif request.GET.sort == "featured" %}Featured First
                                {% else %}Sort By
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&sort=price{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Price: Low to High
                                </a></li>
                                <li><a class="dropdown-item" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&sort=-price{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Price: High to Low
                                </a></li>
                                <li><a class="dropdown-item" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&sort=validity{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Validity: Low to High
                                </a></li>
                                <li><a class="dropdown-item" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&sort=-validity{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Validity: High to Low
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&sort=popular{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-fire me-1 text-warning"></i> Most Popular
                                </a></li>
                                <li><a class="dropdown-item" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&sort=featured{% for key, value in request.GET.items %}{% if key != 'sort' and key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    <i class="fas fa-star me-1 text-primary"></i> Featured First
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Filters Display -->
            {% if request.GET %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-2">
                        <!-- Plan Type Badge -->
                        {% if request.GET.plan_type_filter == 'new_connection' %}
                        <span class="badge bg-success-subtle text-success border border-success-subtle d-flex align-items-center">
                            <i class="fas fa-sim-card me-1"></i> New Connection Plans
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-danger ms-2">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                        {% elif request.GET.plan_type_filter == 'port_in' %}
                        <span class="badge bg-info-subtle text-info border border-info-subtle d-flex align-items-center">
                            <i class="fas fa-exchange-alt me-1"></i> Port-in (MNP) Plans
                            <a href="?{% for key, value in request.GET.items %}{% if key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="text-danger ms-2">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                        {% endif %}
                        
                        <!-- Other Filters -->
                        {% for key, value in request.GET.items %}
                        {% if key != 'page' and key != 'sort' and key != 'plan_type_filter' and value %}
                        <span class="badge bg-light text-dark border d-flex align-items-center">
                            {% if key == 'operator' %}
                                {% for op in all_operators %}
                                    {% if value == op.id|stringformat:"i" %}
                                    <i class="fas fa-tower-cell me-1"></i>{{ op.name }}
                                    {% endif %}
                                {% endfor %}
                            {% elif key == 'category' %}
                                {% for cat in categories %}
                                    {% if value == cat.id|stringformat:"i" %}
                                    <i class="{{ cat.icon|default:'fas fa-tag' }} me-1"></i>{{ cat.name }}
                                    {% endif %}
                                {% endfor %}
                            {% elif key == 'plan_type' %}
                                <i class="fas fa-star me-1"></i>{{ value|title }}
                            {% elif key == 'data' %}
                                <i class="fas fa-database me-1"></i>{{ value }}
                            {% elif key == 'max_price' %}
                                <i class="fas fa-rupee-sign me-1"></i>Under ₹{{ value }}
                            {% endif %}
                            <a href="?{% for k, v in request.GET.items %}{% if k != key and k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}" class="text-danger ms-2">
                                <i class="fas fa-times"></i>
                            </a>
                        </span>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Plans Grid -->
            {% if plans %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for plan in plans %}
                <div class="col">
                    <div class="clean-plan-card">
                        <!-- Plan Type Badge -->
                        {% if plan.plan_type == 'port_in' %}
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-info text-white">
                                <i class="fas fa-exchange-alt me-1"></i> MNP
                            </span>
                        </div>
                        {% elif plan.plan_type == 'new_connection' %}
                        <div class="position-absolute top-0 end-0 m-3">
                            <span class="badge bg-success text-white">
                                <i class="fas fa-sim-card me-1"></i> New
                            </span>
                        </div>
                        {% endif %}

                        <!-- Operator Section -->
                        <div class="operator-section mb-3">
                            <div class="d-flex align-items-center">
                                {% if plan.operator.logo %}
                                <img src="{{ plan.operator.logo.url }}" 
                                     alt="{{ plan.operator.name }}"
                                     class="operator-logo-clean me-3"
                                     onerror="this.src='https://via.placeholder.com/40x40/e5e7eb/374151?text={{ plan.operator.name|slice:":1" }}'">
                                {% else %}
                                <div class="operator-logo-placeholder-clean me-3">
                                    {{ plan.operator.name|slice:":1" }}
                                </div>
                                {% endif %}
                                <div class="flex-grow-1">
                                    <h6 class="operator-name-clean mb-0 fw-bold">{{ plan.operator.name }}</h6>
                                    <small class="operator-type-clean text-muted">{{ plan.category.name }}</small>
                                </div>
                                {% if plan.is_popular or plan.is_featured %}
                                <div class="plan-status-badges">
                                    {% if plan.is_popular %}
                                    <span class="badge trending-badge">
                                        <i class="fas fa-fire me-1"></i>
                                    </span>
                                    {% endif %}
                                    {% if plan.is_featured %}
                                    <span class="badge featured-badge">
                                        <i class="fas fa-star me-1"></i>
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Plan Name -->
                        <h5 class="plan-title-clean mb-2">{{ plan.name }}</h5>
                        
                        <!-- Special Bonus -->
                        {% if plan.plan_type == 'port_in' and plan.port_in_bonus %}
                        <div class="special-bonus mb-2">
                            <span class="badge bg-info-subtle text-info">
                                <i class="fas fa-gift me-1"></i> {{ plan.port_in_bonus }}
                            </span>
                        </div>
                        {% elif plan.plan_type == 'new_connection' and plan.new_connection_bonus %}
                        <div class="special-bonus mb-2">
                            <span class="badge bg-success-subtle text-success">
                                <i class="fas fa-gift me-1"></i> {{ plan.new_connection_bonus }}
                            </span>
                        </div>
                        {% endif %}
                        
                        <!-- Price Section -->
                        <div class="price-section-clean mb-3">
                            <div class="price-display-clean">
                                <span class="price-currency-clean">₹</span>
                                <span class="price-amount-clean">{{ plan.price|intcomma }}</span>
                            </div>
                            <div class="price-period-clean">
                                <i class="fas fa-calendar-alt me-1"></i>
                                {{ plan.get_full_validity }}
                            </div>
                        </div>

                        <!-- Plan Features -->
                        <div class="plan-features-clean mb-4">
                            {% if plan.data_allowance %}
                            <div class="feature-item-clean">
                                <i class="fas fa-database feature-icon-clean"></i>
                                <span class="feature-text-clean">{{ plan.data_allowance }}</span>
                            </div>
                            {% endif %}
                            
                            {% if plan.voice_calls %}
                            <div class="feature-item-clean">
                                <i class="fas fa-phone-alt feature-icon-clean"></i>
                                <span class="feature-text-clean">{{ plan.voice_calls }}</span>
                            </div>
                            {% endif %}
                            
                            {% if plan.sms %}
                            <div class="feature-item-clean">
                                <i class="fas fa-sms feature-icon-clean"></i>
                                <span class="feature-text-clean">{{ plan.sms }}</span>
                            </div>
                            {% endif %}
                            
                            {% if plan.validity_days %}
                            <div class="feature-item-clean">
                                <i class="fas fa-clock feature-icon-clean"></i>
                                <span class="feature-text-clean">{{ plan.validity_days }} Days</span>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Action Button -->
                        <div class="plan-actions-clean">
                            <a href="{% url 'plan_detail' plan.id %}" class="btn btn-view-details-clean w-100">
                                <i class="fas fa-info-circle me-2"></i> View Details
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if plans.has_other_pages %}
            <nav aria-label="Page navigation" class="mt-5">
                <ul class="pagination justify-content-center">
                    {% if plans.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&page={{ plans.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                    {% endif %}

                    {% for i in plans.paginator.page_range %}
                        {% if plans.number == i %}
                        <li class="page-item active"><span class="page-link">{{ i }}</span></li>
                        {% elif i > plans.number|add:'-3' and i < plans.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ i }}
                            </a>
                        </li>
                        {% endif %}
                    {% endfor %}

                    {% if plans.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&page={{ plans.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

            {% else %}
            <!-- No Results -->
            <div class="card border-0 bg-gradient-light text-center py-5 my-5">
                <div class="card-body">
                    <div class="mb-4">
                        {% if request.GET.plan_type_filter == 'port_in' %}
                        <i class="fas fa-exchange-alt fa-4x text-info opacity-25"></i>
                        {% elif request.GET.plan_type_filter == 'new_connection' %}
                        <i class="fas fa-sim-card fa-4x text-success opacity-25"></i>
                        {% else %}
                        <i class="fas fa-search fa-4x text-muted opacity-25"></i>
                        {% endif %}
                    </div>
                    <h3 class="text-muted mb-3">
                        {% if request.GET.plan_type_filter == 'port_in' %}
                        No MNP (Port-in) plans found
                        {% elif request.GET.plan_type_filter == 'new_connection' %}
                        No New Connection plans found
                        {% else %}
                        No matching plans found
                        {% endif %}
                    </h3>
                    <p class="text-muted mb-4">
                        Try adjusting your filters or switch plan type.
                    </p>
                    <div class="d-flex gap-2 justify-content-center">
                        <a href="{% url 'plan_list' %}" class="btn btn-primary">
                            <i class="fas fa-redo me-2"></i> Reset Filters
                        </a>
                        {% if request.GET.plan_type_filter == 'port_in' %}
                        <a href="?plan_type_filter=new_connection{% for key, value in request.GET.items %}{% if key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-outline-success">
                            <i class="fas fa-sim-card me-2"></i> View New Connection Plans
                        </a>
                        {% elif request.GET.plan_type_filter == 'new_connection' %}
                        <a href="?plan_type_filter=port_in{% for key, value in request.GET.items %}{% if key != 'page' and key != 'plan_type_filter' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-outline-info">
                            <i class="fas fa-exchange-alt me-2"></i> View MNP Plans
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Featured Plans Banner -->
<div class="container-fluid mt-5">
    <div class="row align-items-center bg-gradient-primary rounded-4 overflow-hidden p-4">
        <div class="col-md-8">
            <h3 class="text-white fw-bold mb-3">Need Help Choosing The Right Plan?</h3>
            <p class="text-white-75 mb-0">Our experts analyze your usage pattern and recommend the perfect plan for you.</p>
        </div>
        <div class="col-md-4 text-end">
            <a href="#" class="btn btn-light btn-lg">
                <i class="fas fa-headset me-2"></i> Get Expert Advice
            </a>
        </div>
    </div>
</div>

<!-- Categories Section -->
<div class="container-fluid mt-5 pt-5">
    <h3 class="fw-bold text-center mb-4">Browse by Category</h3>
    <div class="row g-4">
        {% for category in categories %}
        <div class="col-md-3 col-6">
            <a href="{% url 'plan_list' %}?plan_type_filter={{ request.GET.plan_type_filter|default:'new_connection' }}&category={{ category.id }}" class="text-decoration-none">
                <div class="category-card text-center">
                    <div class="category-icon" style="background: 
                        {% if category.name == 'Prepaid' %}linear-gradient(135deg, #667eea, #764ba2)
                        {% elif category.name == 'Postpaid' %}linear-gradient(135deg, #f093fb, #f5576c)
                        {% elif category.name == 'Data' %}linear-gradient(135deg, #4facfe, #00f2fe)
                        {% elif category.name == 'International' %}linear-gradient(135deg, #43e97b, #38f9d7)
                        {% else %}linear-gradient(135deg, #fa709a, #fee140){% endif %}">
                        <i class="{{ category.icon|default:'fas fa-tag' }} fa-lg"></i>
                    </div>
                    <h6 class="fw-bold mt-3 mb-1">{{ category.name }}</h6>
                    <p class="text-muted small">{{ category.plan_count }} Plans</p>
                </div>
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Custom CSS Variables */
    :root {
        --operator-airtel: #E31E24;
        --operator-jio: #1D62B4;
        --operator-vi: #7B0099;
        --operator-bsnl: #003366;
        --operator-default: #6366f1;
    }
    
    /* Clean Plan Card Styles */
    .clean-plan-card {
        background: white;
        border-radius: 16px;
        padding: 20px;
        height: 100%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        position: relative;
        overflow: hidden;
    }
    
    .clean-plan-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        border-color: #c7d2fe;
    }
    
    /* Special Bonus Styles */
    .special-bonus .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
        border-radius: 8px;
    }
    
    /* Operator Section */
    .operator-section {
        padding-bottom: 15px;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .operator-logo-clean {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        object-fit: contain;
        border: 1px solid #e5e7eb;
        padding: 4px;
        background: white;
    }
    
    .operator-logo-placeholder-clean {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        font-weight: bold;
        border: 1px solid #e5e7eb;
    }
    
    .operator-name-clean {
        font-size: 1rem;
        color: #1f2937;
        line-height: 1.2;
    }
    
    .operator-type-clean {
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .plan-status-badges {
        display: flex;
        gap: 5px;
    }
    
    .trending-badge {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #92400e;
        border: 1px solid #fbbf24;
        padding: 4px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }
    
    .featured-badge {
        background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
        color: #3730a3;
        border: 1px solid #6366f1;
        padding: 4px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }
    
    /* Plan Title */
    .plan-title-clean {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1f2937;
        line-height: 1.3;
        margin-top: 10px;
        min-height: 50px;
    }
    
    /* Price Section */
    .price-section-clean {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
        border-radius: 12px;
        padding: 15px;
        text-align: center;
        margin: 15px 0;
        border: 1px solid rgba(99, 102, 241, 0.1);
    }
    
    .price-display-clean {
        display: flex;
        align-items: baseline;
        justify-content: center;
        gap: 2px;
        margin-bottom: 5px;
    }
    
    .price-currency-clean {
        font-size: 1.1rem;
        color: #6366f1;
        font-weight: 600;
    }
    
    .price-amount-clean {
        font-size: 2.2rem;
        font-weight: 800;
        color: #1f2937;
        line-height: 1;
    }
    
    .price-period-clean {
        font-size: 0.85rem;
        color: #6b7280;
        font-weight: 500;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
    }
    
    /* Plan Features */
    .plan-features-clean {
        flex-grow: 1;
    }
    
    .feature-item-clean {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 0;
        border-bottom: 1px dashed #f3f4f6;
    }
    
    .feature-item-clean:last-child {
        border-bottom: none;
    }
    
    .feature-icon-clean {
        width: 20px;
        color: #6366f1;
        font-size: 0.9rem;
    }
    
    .feature-text-clean {
        font-size: 0.9rem;
        color: #374151;
        font-weight: 500;
    }
    
    /* Action Button */
    .plan-actions-clean {
        margin-top: 15px;
    }
    
    .btn-view-details-clean {
        background: #f9fafb;
        color: #4f46e5;
        border: 2px solid #e0e7ff;
        border-radius: 10px;
        padding: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-view-details-clean:hover {
        background: #4f46e5;
        color: white;
        border-color: #4f46e5;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    
    /* Plan Type Toggle Styles */
    .btn-group .btn-outline-primary.active {
        background-color: #4f46e5;
        color: white;
        border-color: #4f46e5;
    }
    
    .btn-group .btn-outline-primary {
        border-color: #4f46e5;
        color: #4f46e5;
    }
    
    .btn-group .btn-outline-primary:hover {
        background-color: rgba(79, 70, 229, 0.1);
    }
    
    /* Plan Type Specific Styling */
    .clean-plan-card[data-plan-type="port_in"] {
        border-top: 3px solid #0dcaf0;
    }
    
    .clean-plan-card[data-plan-type="new_connection"] {
        border-top: 3px solid #198754;
    }
    
    /* Category Cards */
    .category-card {
        padding: 25px 15px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .category-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    .category-icon {
        width: 60px;
        height: 60px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        margin: 0 auto;
    }
    
    /* Custom Badge Colors */
    .bg-purple {
        background-color: #8b5cf6 !important;
    }
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }
    
    .bg-gradient-light {
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%) !important;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .clean-plan-card {
            padding: 15px;
        }
        
        .operator-logo-clean {
            width: 35px;
            height: 35px;
        }
        
        .operator-logo-placeholder-clean {
            width: 35px;
            height: 35px;
            font-size: 1rem;
        }
        
        .price-amount-clean {
            font-size: 1.8rem;
        }
        
        .plan-title-clean {
            font-size: 1rem;
            min-height: 40px;
        }
        
        .btn-group .btn {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }
    }
    
    @media (max-width: 576px) {
        .clean-plan-card {
            padding: 12px;
        }
        
        .category-card {
            padding: 20px 10px;
        }
        
        .feature-item-clean {
            padding: 6px 0;
            font-size: 0.85rem;
        }
        
        .btn-view-details-clean {
            padding: 8px;
            font-size: 0.9rem;
        }
    }
    
    /* Animation */
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .clean-plan-card {
        animation: fadeIn 0.5s ease-out;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Price Range Slider
        function updatePriceValue(value) {
            document.getElementById('priceValue').textContent = '₹' + value;
            document.getElementById('maxPrice').value = value;
        }
        
        // Submit form when price changes (with debounce)
        let priceTimeout;
        document.getElementById('priceRange').addEventListener('change', function() {
            clearTimeout(priceTimeout);
            priceTimeout = setTimeout(function() {
                document.getElementById('filterForm').submit();
            }, 500);
        });
        
        // Initialize price slider
        const maxPrice = "{{ request.GET.max_price|default:2000 }}";
        document.getElementById('priceRange').value = maxPrice;
        updatePriceValue(maxPrice);
        
        // Plan Type Toggle Function
        function togglePlanType(planType) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.set('plan_type_filter', planType);
            urlParams.delete('page'); // Reset to first page
            
            // Keep other filters
            const otherParams = ['operator', 'category', 'max_price', 'data', 'sort'];
            otherParams.forEach(param => {
                if (urlParams.has(param)) {
                    // Keep existing value
                }
            });
            
            window.location.href = window.location.pathname + '?' + urlParams.toString();
        }
        
        // Add plan type data attribute to cards
        const planCards = document.querySelectorAll('.clean-plan-card');
        
        planCards.forEach(card => {
            const planTypeBadge = card.querySelector('.badge.bg-info, .badge.bg-success');
            if (planTypeBadge) {
                if (planTypeBadge.classList.contains('bg-info')) {
                    card.setAttribute('data-plan-type', 'port_in');
                } else if (planTypeBadge.classList.contains('bg-success')) {
                    card.setAttribute('data-plan-type', 'new_connection');
                }
            }
            
            // Add operator-specific styling
            const operatorName = card.querySelector('.operator-name-clean').textContent.trim();
            const operatorNameElement = card.querySelector('.operator-name-clean');
            operatorNameElement.setAttribute('data-operator', operatorName);
        });
        
        // Update toggle buttons active state
        const toggleButtons = document.querySelectorAll('[name="plan_type_toggle"]');
        const currentPlanType = "{{ request.GET.plan_type_filter|default:'new_connection' }}";
        
        toggleButtons.forEach(button => {
            if (button.value === currentPlanType) {
                button.nextElementSibling.classList.add('active');
            }
        });
        
        // Image fallback for logos
        const operatorLogos = document.querySelectorAll('.operator-logo-clean');
        operatorLogos.forEach(logo => {
            logo.addEventListener('error', function() {
                const operatorName = this.closest('.operator-section').querySelector('.operator-name-clean').textContent;
                const placeholder = document.createElement('div');
                placeholder.className = 'operator-logo-placeholder-clean';
                placeholder.textContent = operatorName.charAt(0);
                this.parentNode.replaceChild(placeholder, this);
            });
        });
        
        // Initialize tooltips for badges
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}